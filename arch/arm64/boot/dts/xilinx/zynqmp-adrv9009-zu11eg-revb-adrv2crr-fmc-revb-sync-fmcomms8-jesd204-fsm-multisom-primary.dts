// SPDX-License-Identifier: GPL-2.0
/*
 * Analog Devices ADRV2CRR-FMC using ADRV9009-ZU11EG System on Module + AD-FMCOMMS8-EBZ
 * Primary module in a Multi-SoM / Multi-Topology setup.
 * https://wiki.analog.com/resources/eval/user-guides/adrv9009-zu11eg/adrv2crr-fmc_carrier_board
 * https://wiki.analog.com/resources/eval/user-guides/ad-fmcomms8-ebz
 * https://wiki.analog.com/resources/tools-software/linux-drivers/iio-transceiver/adrv9009
 * https://wiki.analog.com/resources/tools-software/linux-software/adrv9009_advanced_plugin
 * https://wiki.analog.com/resources/tools-software/linux-drivers/jesd204/jesd204-fsm-framework
 *
 * hdl_project: <adrv9009zu11eg/adrv2crr_fmcomms8>
 * board_revision: <>
 *
 * Copyright (C) 2020 Analog Devices Inc.
 */
#include "zynqmp-adrv9009-zu11eg-revb-adrv2crr-fmc-revb-sync-fmcomms8-jesd204-fsm.dts"
#include <dt-bindings/iio/frequency/hmc7044.h>
#include <dt-bindings/jesd204/device-states.h>

&trx0_adrv9009 {
	jesd204-stop-states = <
		JESD204_FSM_STATE_CLK_SYNC_STAGE1
		JESD204_FSM_STATE_CLK_SYNC_STAGE2
		JESD204_FSM_STATE_CLK_SYNC_STAGE3
		JESD204_FSM_STATE_LINK_SETUP
		JESD204_FSM_STATE_OPT_SETUP_STAGE1
		JESD204_FSM_STATE_OPT_SETUP_STAGE2
		JESD204_FSM_STATE_OPT_SETUP_STAGE3
		JESD204_FSM_STATE_OPT_SETUP_STAGE4
		JESD204_FSM_STATE_OPT_SETUP_STAGE5
		JESD204_FSM_STATE_CLOCKS_ENABLE
		JESD204_FSM_STATE_LINK_ENABLE>;
};

&hmc7044 {
	adi,pfd1-maximum-limit-frequency-hz = <7680000>;
};

&hmc7044_c1 {
	adi,control0-rb4-enable;
};

&hmc7044_c3 {
	adi,control0-rb4-enable;
};

&hmc7044_c8 {
	adi,control0-rb4-enable;
};

&hmc7044_c9 {
	adi,control0-rb4-enable;
};

&hmc7044_car {
	jesd204-inputs = <&hmc7044_ext 0 FRAMER_LINK_RX>,
		<&hmc7044_ext 0 FRAMER_LINK_ORX>,
		<&hmc7044_ext 0 DEFRAMER_LINK_TX>;

	/delete-property/ jesd204-sysref-provider;

	adi,pll1-clkin-frequencies = <0 30720000 0 0>;

	adi,pfd1-maximum-limit-frequency-hz = <7680000>;
};

&hmc7044_fmc {
	adi,pfd1-maximum-limit-frequency-hz = <7680000>;
};

&hmc7044_ext {
	jesd204-device;
	#jesd204-cells = <2>;

	jesd204-sysref-provider;

	adi,pulse-generator-mode = <HMC7044_PULSE_GEN_1_PULSE>;
	adi,hmc-two-level-tree-sync-en;

	adi,pll1-clkin-frequencies = <0 30720000 30720000 38400000>;
	adi,pll1-ref-prio-ctrl = <0x39>; /* CLKIN1 -> CLKIN2 -> CLKIN3 -> CLKIN0 */
	adi,pll1-ref-autorevert-enable;

	adi,clkin2-buffer-mode = <0x07>;
	adi,clkin3-buffer-mode = <0x07>;

	adi,pfd1-maximum-limit-frequency-hz = <7680000>;
};

&hmc7044_ext_c5 {
	reg = <4>;
};

&hmc7044_ext_c0 {
	reg = <5>;
};

&hmc7044_ext_c2 {
	reg = <12>;
};

&gpio {
	vcxo_select {
		gpio-hog;
		gpios = <170 0>;
		/*
		 * high - for 122.88 MHz HMC7044 vcxo
		 * low - for 100 MHz HMC7044 vcxo
		*/
		output-high;
		line-name = "vcxo-select";
	};

	hmc7044_ext_reset {
		gpio-hog;
		gpios = <169 0x00>;
		output-low;
		line-name = "hmc7044-ext-reset";
	};

	ad9545_reset {
		gpio-hog;
		gpios = <168 0x00>;
		output-high;
		line-name = "ad9545-reset";
	};
};

/ {
	ref_clk2: ref_clk_2 {
		compatible = "fixed-clock";
		#clock-cells = <0x01>;
		clock-frequency = <10000000>;
		clock-output-names = "Ref-B";
	};

	ref_clk3: ref_clk_3 {
		compatible = "fixed-clock";
		#clock-cells = <0x01>;
		clock-frequency = <0x01>;
		clock-output-names = "Ref-BB";
	};

	ref_m1: ref_m1_clk {
		compatible = "fixed-clock";
		#clock-cells = <0x01>;
		clock-frequency = <50000000>;
		clock-output-names = "Ref-M1";
	};
};

&spi0 {
	ad9545_synchrona: ad9545@5 {
		compatible = "adi,ad9545";
		reg = <5>;
		#address-cells = <1>;
		#size-cells = <0>;
		adi,ref-crystal;
		adi,ref-frequency-hz = <49152000>;
		spi-max-frequency = <1000000>;
		clock-names = "Ref-B", "Ref-BB", "Ref-M1";
		clocks = <&ref_clk2 2>, <&ref_clk3 3>, <&ref_m1 1>;
		#clock-cells = <2>;
		assigned-clocks = <&ad9545_synchrona AD9545_CLK_NCO AD9545_NCO0>,
			<&ad9545_synchrona AD9545_CLK_PLL AD9545_PLL0>,
			<&ad9545_synchrona AD9545_CLK_PLL AD9545_PLL1>,
			<&ad9545_synchrona AD9545_CLK_OUT AD9545_Q0A>,
			<&ad9545_synchrona AD9545_CLK_OUT AD9545_Q0B>,
			<&ad9545_synchrona AD9545_CLK_OUT AD9545_Q1A>,
			<&ad9545_synchrona AD9545_CLK_OUT AD9545_Q1B>,
			<&ad9545_synchrona AD9545_CLK_AUX_TDC AD9545_CLK_AUX_TDC0>;
		assigned-clock-rates = <10000>,
			<1413120000>,
			<1812480000>,
			<30720000>,
			<30720000>,
			<30720000>,
			<30720000>,
			<200000>;
		assigned-clock-nshot = <0>, <0>, <0>, <0>, <0>, <0>, <1>, <0>;
		aux-tdc-clk@0 {
			reg = <0>;
			adi,pin-nr = <1>;
		};
		aux-dpll@0 {
			reg = <0>;
			adi,compensation-source = <4>;
			adi,aux-dpll-bw-mhz = <50000>;
		};
		/* Ref B*/
		ref-input-clk@2 {
			reg = <2>;
			adi,single-ended-mode = <DRIVER_MODE_AC_COUPLED>;
			adi,r-divider-ratio = <125>;
			adi,ref-dtol-pbb = <10000000>;
			adi,ref-monitor-hysteresis-pbb = <87500>;
			adi,ref-validation-timer-ms = <10>;
			adi,freq-lock-threshold-ps = <2000>;
			adi,phase-lock-threshold-ps = <2000>;
			adi,freq-lock-fill-rate = <20>;
			adi,freq-lock-drain-rate = <20>;
			adi,phase-lock-fill-rate = <20>;
			adi,phase-lock-drain-rate = <20>;
		};
		/* Ref BB*/
		ref-input-clk@3 {
			reg = <3>;
			adi,single-ended-mode = <DRIVER_MODE_DC_COUPLED_1V8>;
			adi,r-divider-ratio = <1>;
			adi,ref-dtol-pbb = <100000>;
			adi,ref-monitor-hysteresis-pbb = <12500>;
			adi,ref-validation-timer-ms = <1000>;
			adi,freq-lock-threshold-ps = <2000>;
			adi,phase-lock-threshold-ps = <2000>;
			adi,freq-lock-fill-rate = <100>;
			adi,freq-lock-drain-rate = <10>;
			adi,phase-lock-fill-rate = <100>;
			adi,phase-lock-drain-rate = <10>;
		};
		aux-nco-clk@AD9545_NCO0 {
			reg = <AD9545_NCO0>;
			adi,freq-lock-threshold-ps = <0xFFFFFF>;
			adi,phase-lock-threshold-ps = <0xFFFFFF>;
		};
		pll-clk@AD9545_PLL0 {
			reg = <AD9545_PLL0>;
			#address-cells = <1>;
			#size-cells = <0>;
			// Uncoment below for Internal Zero-Delay operation
			/*
			adi,pll-internal-zero-delay-feedback = <AD9545_Q0A>;
			adi,pll-internal-zero-delay-feedback-hz = <10000000>;
			adi,pll-slew-rate-limit-ps = <4000000000>;
			*/
			profile@0 {
				reg = <0>;
				adi,pll-source = <3>;
				adi,profile-priority = <0>;
				adi,pll-loop-bandwidth-uhz = <50000>;
				adi,fast-acq-excess-bw = <8>;
				adi,fast-acq-timeout-ms = <10000>;
				adi,fast-acq-lock-settle-ms = <1000>;
			};
			profile@1 {
				reg = <1>;
				adi,pll-source = <2>;
				adi,profile-priority = <10>;
				adi,pll-loop-bandwidth-uhz = <200000000>;
			};
		};
		pll-clk@AD9545_PLL1 {
			reg = <AD9545_PLL1>;
			#address-cells = <1>;
			#size-cells = <0>;

			adi,pll-internal-zero-delay-feedback = <AD9545_Q1A>;
			adi,pll-internal-zero-delay-feedback-hz = <10000000>;
			adi,pll-slew-rate-limit-ps = <4000000000>;

			profile@0 {
				reg = <0>;
				adi,pll-source = <3>;
				adi,profile-priority = <0>;
				adi,pll-loop-bandwidth-uhz = <50000>;
				adi,fast-acq-excess-bw = <8>;
				adi,fast-acq-timeout-ms = <10000>;
				adi,fast-acq-lock-settle-ms = <1000>;
			};
			profile@1 {
				reg = <1>;
				adi,pll-source = <2>;
				adi,profile-priority = <10>;
				adi,pll-loop-bandwidth-uhz = <200000000>;
			};
		};
		/* Output Q0A CML -> J27 J28 */
		output-clk@AD9545_Q0A {
			reg = <AD9545_Q0A>;
			adi,output-mode = <DRIVER_MODE_SINGLE_DIV_DIF>;
			adi,current-source-microamp = <15000>;
		};
		output-clk@AD9545_Q0B {
			reg = <AD9545_Q0B>;
			adi,output-mode = <DRIVER_MODE_SINGLE_DIV_DIF>;
			adi,current-source-microamp = <15000>;
		};
		/* Output Q1A -> CLK_IN 2 of HMC7044 */
		output-clk@AD9545_Q1A {
			reg = <AD9545_Q1A>;
			adi,output-mode = <DRIVER_MODE_SINGLE_DIV_DIF>;
			adi,current-source-microamp = <15000>;
		};
		/* Output Q1B -> SYNC of HMC7044 */
		output-clk@AD9545_Q1B {
			reg = <AD9545_Q1B>;
			adi,output-mode = <DRIVER_MODE_SINGLE_DIV_DIF>;
			adi,current-source-microamp = <15000>;
		};
	};
};
