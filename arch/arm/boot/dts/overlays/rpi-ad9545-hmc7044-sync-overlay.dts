/dts-v1/;
/plugin/;

/* AD-SYNCHRONA14-EBZ Rev. B - DT */

#define REF_DIV		6


//#undef MASTER

//#define MASTER		1
#define CLOCK_DIST	1

#define PLL_FREQ	2949120000
#define CLKIN1_FREQ	(PLL_FREQ / REF_DIV)

/ {
	#include <dt-bindings/clock/ad9545.h>
	#include <dt-bindings/iio/frequency/hmc7044.h>
	#include <dt-bindings/gpio/gpio.h>
	#include <dt-bindings/jesd204/device-states.h>


	compatible = "brcm,bcm2835", "brcm,bcm2708", "brcm,bcm2709", "brcm,bcm2711";

	fragment@0 {

		target-path = "/";
		__overlay__ {

			ref_clk2: ref_clk_2 {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <10000000>;
				clock-output-names = "Ref-B";
			};

			ref_clk3: ref_clk_3 {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <1>;
				clock-output-names = "Ref-BB";
			};

			ref_m1: ref_m1_clk {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <50000000>;
				clock-output-names = "Ref-M1";
			};

			hmc_ref_clk0: hmc_ref_clk_0 {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <10000000>;
				clock-output-names = "HMC-REF_CLKIN0";
			};

			hmc_ref_clk1: hmc_ref_clk_1 {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <CLKIN1_FREQ>;
				clock-output-names = "HMC-REF_CLKIN1";
			};

			hmc_ref_clk3: hmc_ref_clk_3 {
				compatible = "fixed-clock";
				#clock-cells = <1>;

				clock-frequency  = <38400000>;
				clock-output-names = "HMC-REF_CLKIN3";
			};

			top_device@0 {
				compatible = "adi,iio-fake-platform-device";
				adi,faked-dev = <&top_device>;
				adi,attribute-names =
					"jesd204_fsm_ctrl", "jesd204_fsm_error",
					"jesd204_fsm_paused", "jesd204_fsm_resume",
					"jesd204_fsm_state";
				label = "top_device";
			};

			top_device: jesd204-top-device {
				compatible = "adi,jesd204-top-device-1.0";

				jesd204-device;
				#jesd204-cells = <2>;
				jesd204-top-device = <0>; /* This is the TOP device for TOPOLOGY 1*/
				jesd204-link-ids = <0>;
				//jesd204-ignore-errors;

				jesd204-stop-states = <
					JESD204_FSM_STATE_CLK_SYNC_STAGE1
					JESD204_FSM_STATE_CLK_SYNC_STAGE2
					JESD204_FSM_STATE_CLK_SYNC_STAGE3>;

				jesd204-inputs =
					<&hmc7044_fmc 0 0>;

				adi,jesd-links {
					#size-cells = <0>;
					#address-cells = <1>;

					rx_jesd_l0: link@0 {
						reg = <0>;

						adi,sample-rate = /bits/ 64 <122880000>;

						adi,subclass = <0>;			/* JESD SUBCLASS 0,1,2 */
						adi,version = <2>;			/* JESD VERSION 0=204A,1=204B,2=204C */
						adi,dual-link = <0>;			/* JESD Dual Link Mode */
						adi,converters-per-device = <2>;	/* JESD M */
						adi,octets-per-frame = <4>;		/* JESD F */
						adi,frames-per-multiframe = <32>;	/* JESD K */
						adi,converter-resolution = <16>;	/* JESD N */
						adi,bits-per-sample = <16>;		/* JESD NP' */
						adi,control-bits-per-sample = <0>;	/* JESD CS */
						adi,lanes-per-device = <2>;		/* JESD L */
						adi,samples-per-converter-per-frame = <4>; /* JESD S */
						adi,high-density = <0>;			/* JESD HD */
						adi,scrambling = <1>;
					};

				};
			};
		};
	};

	fragment@1 {
		target = <&spi0>;
		__overlay__ {
			compatible = "brcm,bcm2835-spi";

			#address-cells = <0x1>;
			#size-cells = <0>;
			status = "okay";

			hmc7044_fmc: hmc7044@1 {
				reg = <0x1>;

				#address-cells = <1>;
				#size-cells = <0>;
				#clock-cells = <1>;

				compatible = "adi,hmc7044";
				spi-max-frequency = <1000000>;

				jesd204-device;
				#jesd204-cells = <2>;
				jesd204-sysref-provider;

				adi,jesd204-max-sysref-frequency-hz = <2000000>; /* 2 MHz */

				adi,pll1-clkin-frequencies = <38400000 38400000 38400000 38400000>;

				/*
					HMC7044 Input Clocking Priorities:
					CLKIN2 -> CLKIN0 -> CLKIN1 -> CLKIN3
					Where:
						- CLKIN2 - AD9545
						- CLKIN0 - J23/J24
						- CLKIN1 - J25/J26
						- CLKIN3 - 40 MHz or 38.4 MHz TCXO
				*/


				adi,pll1-ref-autorevert-enable;

				adi,pll1-loop-bandwidth-hz = <200>;

				adi,sync-pin-mode = <0>;

				adi,hmc-two-level-tree-sync-en;

#ifdef MASTER
				adi,pll1-ref-prio-ctrl = <0xFF>; /* CLKIN 3 */
				adi,clkin0-buffer-mode = <0x00>;
				adi,clkin1-buffer-mode = <0x00>;
				adi,clkin2-buffer-mode = <0x00>;
				adi,clkin3-buffer-mode = <0x07>;
				clocks = <&hmc_ref_clk3 0>;
				clock-names = "clkin3";
#else
				adi,pll1-ref-prio-ctrl = <0x55>; /* CLKIN 1 */
				adi,clkin1-vco-in-enable;
				adi,clkin0-rf-sync-enable;
				adi,clkin0-buffer-mode = <0x0b>; /* Needs HW modification - remove AC couble Caps */
				adi,clkin1-buffer-mode = <0x07>;
				clocks = <&hmc_ref_clk0 0>, <&hmc_ref_clk1 0>, <&hmc_ref_clk3 0>;
				clock-names = "clkin0", "clkin1", "clkin3";
#endif

				/* depends on VCXO_SELECT_PI */
				adi,vcxo-frequency = <122880000>;
				adi,pll2-output-frequency = <PLL_FREQ>;
				adi,sysref-timer-divider = <1024>;
				adi,pulse-generator-mode = <HMC7044_PULSE_GEN_1_PULSE>;

				adi,oscin-buffer-mode = <0x15>;

				adi,gpi-controls = <0x00 0x00 0x00 0x00>;
				adi,gpo-controls = <0x1f 0x2b 0x00 0x00>;

				clock-output-names = "HMC7044_OUT0", "HMC7044_OUT1",
						     "HMC7044_OUT2", "HMC7044_OUT3",
						     "HMC7044_OUT4", "HMC7044_OUT5",
						     "HMC7044_OUT6", "HMC7044_OUT7",
						     "HMC7044_OUT8", "HMC7044_OUT9",
						     "HMC7044_OUT10", "HMC7044_OUT11",
						     "HMC7044_OUT12", "HMC7044_OUT13";

				/*
				 * Channels in CMOS mode should configure
				 * adi,driver-impedance-mode to:
				 * 0 - no output
				 * 1 - N output
				 * 2 - P ourput
				 * 3 - both
				 * Depending on the desired output pin.
				 */
				hmc7044_car_c6: channel@6 {
					reg = <6>;
					adi,extended-name = "RFSYNC_2_CLKOUT6_CH6";
					adi,divider = <1024>; /* set by the jesd204-fsm */
					adi,driver-mode = <HMC7044_DRIVER_MODE_LVPECL>;
					adi,startup-mode-dynamic-enable;
					adi,high-performance-mode-disable;
					adi,force-mute-enable;
				};

				hmc7044_car_c7: channel@7 {
					reg = <7>;
					adi,extended-name = "REFCLK_1_CLKOUT7_CH4";
					adi,divider = <REF_DIV>;
					adi,driver-mode = <HMC7044_DRIVER_MODE_LVPECL>;
				};

				hmc7044_car_c11: channel@11 {
					reg = <11>;
					adi,extended-name = "RFSYNC_1_CLKOUT11_CH5";
					adi,divider = <1024>; /* set by the jesd204-fsm */
					adi,driver-mode = <HMC7044_DRIVER_MODE_LVPECL>;
					adi,startup-mode-dynamic-enable;
					adi,high-performance-mode-disable;
					adi,force-mute-enable;
				};

				hmc7044_car_c10: channel@10 {
					reg = <10>;
					adi,extended-name = "REFCLK_1_CLKOUT10_CH3";
					adi,divider = <REF_DIV>;
					adi,driver-mode = <HMC7044_DRIVER_MODE_LVPECL>;
				};
			};
		};
	};

	fragment@2 {
		target = <&gpio>;
		__overlay__ {

			gpio_overrides: gpio_overrides {
				/* GPIO_4_HMC7044_CAR - 4
				 * GPIO_1_HMC7044_CAR - 17
				 * GPIO_2_HMC7044_CAR - 27
				 * GPIO_3_HMC7044_CAR - 22
				 * RESETB_AD9545_PI - 25
				 * RESET_HMC7044_CAR_PI - 5
				 * VCXO_SELECT_PI - 6
				 * GPIO19_PI - 19
				 * GPIO26_PI - 26
				 * GPIO23_PI - 16 - SYNC Enable
				 */

				pin-25-reset-high {
					pins = "gpio25";
					function = "gpio_out";
					bias-pull-up;
					output-high;
				};

				pin-5-reset-low {
					pins = "gpio5";
					function = "gpio_out";
					bias-pull-down;
				};

				pin-6-vcxo-select {
					pins = "gpio6";
					function = "gpio_out";
					//bias-pull-up;
					output-high;

					bias-pull-down;
				};

				pin-12-red_led {
					pins = "gpio12";
					function = "gpio_out";
					bias-pull-up;
					output-high;
					export;
				};

				pin-16-sync-en {
					pins = "gpio23";
					function = "gpio_out";
					bias-pull-down;
				};

				/*
				pin-40-power-off-ok {
					pins = "gpio21";
					function = "gpio_out";
					bias-pull-up;
					output-high;
				};
				*/
			};
		};
	};

	fragment@3 {
		target-path = "/";
		__overlay__ {
			power_ctrl: power_ctrl {
				compatible = "gpio-poweroff";
				gpios = <&gpio 21 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
				input;
			};
		};
	};

	fragment@4 {
		target-path = "/soc";
		__overlay__ {
			shutdown_button: shutdown_button@3 {
				compatible = "gpio-keys";
				status = "okay";

				button: shutdown {
					label = "shutdown";
					linux,code = <116>; // KEY_POWER
					gpios = <&gpio 20 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
					debounce-interval = <100>;
				};
			};
		};
	};

	fragment@5 {
		target = <&spidev0>;
		__overlay__ {
			status = "disabled";
		};
	};

	fragment@6 {
		target = <&spidev1>;
		__overlay__ {
			status = "disabled";
		};
	};

	fragment@7 {
		target = <&gpio>;
		__overlay__ {
			pinctrl-names = "default";
			pinctrl-0 = <&gpio_overrides>;
		};
	};

	fragment@8 {
		target = <&i2c1>;
		__overlay__ {
			compatible = "brcm,bcm2711-i2c";
			status = "okay";

			#address-cells = <1>;
			#size-cells = <0>;

			adt7422@48 {
				compatible = "adi,adt7422";
				reg = <0x48>;
			};
		};
	};
};
